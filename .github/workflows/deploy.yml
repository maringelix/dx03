name: ğŸš€ Deploy Application to GKE

on:
  push:
    branches: [main, master]
    paths:
      - 'client/**'
      - 'server/**'
      - 'k8s/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: us-central1
  GKE_CLUSTER: tx03-gke-cluster
  ARTIFACT_REGISTRY: dx03
  NAMESPACE: dx03-dev

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dx03
        uses: actions/checkout@v4
        with:
          path: app

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          echo "ğŸ” Configuring Docker authentication..."
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Get GKE Credentials
        run: |
          echo "ğŸ”‘ Getting GKE credentials..."
          gcloud components install gke-gcloud-auth-plugin --quiet
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Build and Push Frontend
        working-directory: app/client
        run: |
          echo "ğŸ—ï¸ Building frontend image..."
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“„ Files:"
          ls -la
          
          docker build \
            --build-arg VITE_API_URL=/api \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:latest \
            .
          
          echo "ğŸ“¦ Pushing frontend image..."
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:latest
          
          echo "âœ… Frontend image pushed successfully!"

      - name: Build and Push Backend
        working-directory: app/server
        run: |
          echo "ğŸ—ï¸ Building backend image..."
          
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:latest \
            .
          
          echo "ğŸ“¦ Pushing backend image..."
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:latest
          
          echo "âœ… Backend image pushed successfully!"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Get Database Credentials
        id: db_creds
        run: |
          echo "ğŸ” Using database credentials from secrets..."
          echo "::add-mask::${{ secrets.DB_PASSWORD }}"
          echo "db_password=${{ secrets.DB_PASSWORD }}" >> $GITHUB_OUTPUT
          echo "db_host=${{ secrets.DB_HOST }}" >> $GITHUB_OUTPUT
          echo "âœ… Database credentials retrieved"

      - name: Create Kubernetes Namespace
        continue-on-error: true
        run: |
          echo "ğŸ“ Creating namespace..."
          kubectl create namespace ${{ env.NAMESPACE }} || echo "Namespace already exists"
          kubectl label namespace ${{ env.NAMESPACE }} app=dx03 --overwrite

      - name: Create Database Secret
        run: |
          echo "ğŸ” Creating database secret..."
          
          # Delete existing secret if exists
          kubectl delete secret dx03-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          
          # Create new secret (matching backend-deployment.yaml keys)
          echo "ğŸ” Creating secret with password length: ${#PASSWORD_VAR}"
          PASSWORD_VAR="${{ steps.db_creds.outputs.db_password }}"
          kubectl create secret generic dx03-db-secret \
            --from-literal=host=${{ steps.db_creds.outputs.db_host }} \
            --from-literal=port=5432 \
            --from-literal=database=dx03 \
            --from-literal=username=dx03 \
            --from-literal=password="$PASSWORD_VAR" \
            --namespace=${{ env.NAMESPACE }}
          
          # Debug: Verify secret keys (values are hidden)
          echo "ğŸ” Verifying secret keys..."
          kubectl get secret dx03-db-secret -n ${{ env.NAMESPACE }} -o jsonpath='{.data}' | jq 'keys'
          
          echo "âœ… Database secret created"

      - name: Apply ConfigMap
        working-directory: app
        run: |
          echo "âš™ï¸ Applying ConfigMap..."
          
          # Replace environment placeholder
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/configmap.yaml | kubectl apply -f -
          
          echo "âœ… ConfigMap applied"

      - name: Deploy Backend
        working-directory: app
        run: |
          echo "ğŸš€ Deploying backend..."
          
          # Delete old deployments to avoid config errors from old secrets
          kubectl delete deployment dx03-backend -n ${{ env.NAMESPACE }} --ignore-not-found=true
          sleep 10
          
          # Replace placeholders
          sed "s|IMAGE_PLACEHOLDER|${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }}|g; s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/backend-deployment.yaml | kubectl apply -f -
          
          # Apply service (replace placeholder)
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/backend-service.yaml | kubectl apply -f -
          
          echo "â³ Waiting for backend rollout..."
          echo "ğŸ“Š Checking pod status..."
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl describe deployment dx03-backend -n ${{ env.NAMESPACE }} | tail -20
          
          # Show pod details if still pending
          echo "ğŸ” Checking pod events..."
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -20
          kubectl describe pods -n ${{ env.NAMESPACE }} -l app=dx03-backend | grep -A 10 "Events:"
          
          # Wait for pods to start and show logs if crashing
          echo "ğŸ“‹ Waiting 30s for pods to start..."
          sleep 30
          echo "ğŸ“‹ Checking pod logs..."
          kubectl logs -n ${{ env.NAMESPACE }} -l app=dx03-backend --tail=100 --all-containers=true --ignore-errors=true || echo "No logs available yet"
          
          kubectl rollout status deployment/dx03-backend -n ${{ env.NAMESPACE }} --timeout=10m
          
          echo "âœ… Backend deployed successfully!"

      - name: Deploy Frontend
        working-directory: app
        run: |
          echo "ğŸš€ Deploying frontend..."
          
          # Replace placeholders
          sed "s|IMAGE_PLACEHOLDER|${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }}|g; s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/frontend-deployment.yaml | kubectl apply -f -
          
          # Apply service (replace placeholder)
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/frontend-service.yaml | kubectl apply -f -
          
          echo "â³ Waiting for frontend rollout..."
          kubectl rollout status deployment/dx03-frontend -n ${{ env.NAMESPACE }} --timeout=5m
          
          echo "âœ… Frontend deployed successfully!"

      - name: Apply Ingress
        run: |
          echo "ğŸŒ Applying Ingress..."
          
          # Create Ingress
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: dx03-ingress
            namespace: ${{ env.NAMESPACE }}
            annotations:
              kubernetes.io/ingress.class: "gce"
              cloud.google.com/neg: '{"ingress": true}'
          spec:
            rules:
            - http:
                paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: dx03-backend
                      port:
                        number: 80
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: dx03-frontend
                      port:
                        number: 80
          EOF
          
          echo "âœ… Ingress applied!"

      - name: Get Application URLs
        id: urls
        continue-on-error: true  # Don't fail if LB not ready yet
        run: |
          echo "ğŸ” Getting application URLs..."
          
          # Wait up to 10 minutes for ingress to get IP (GCP LB provisioning can take time)
          echo "â³ Waiting for Load Balancer IP (this can take 5-15 minutes)..."
          for i in {1..60}; do
            INGRESS_IP=$(kubectl get ingress dx03-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$INGRESS_IP" ]; then
              echo "ingress_ip=$INGRESS_IP" >> $GITHUB_OUTPUT
              echo "ğŸŒ Ingress IP: $INGRESS_IP"
              break
            fi
            
            # Show progress every 30 seconds
            if [ $((i % 3)) -eq 0 ]; then
              echo "â³ Still waiting... ($i/60 = $((i * 10 / 60)) minutes elapsed)"
            fi
            sleep 10
          done
          
          if [ -z "$INGRESS_IP" ]; then
            echo "âš ï¸  Ingress IP not assigned within 10 minutes"
            echo "â„¹ï¸  This is normal for first deployment - Load Balancer is still provisioning"
            echo "ğŸ’¡ Check status in a few minutes with:"
            echo "   kubectl get ingress dx03-ingress -n ${{ env.NAMESPACE }}"
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo ""
          echo "ğŸ¯ Environment: dev"
          echo "ğŸ“¦ Namespace: ${{ env.NAMESPACE }}"
          echo ""
          echo "ğŸ³ Images:"
          echo "  Frontend: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dx03/frontend:${{ github.sha }}"
          echo "  Backend:  us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dx03/backend:${{ github.sha }}"
          echo ""
          echo "ğŸ”— Services:"
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo ""
          echo "ğŸš€ Deployments:"
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "ğŸ“¦ Pods:"
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo "ğŸ”§ Ingress:"
          kubectl get ingress -n ${{ env.NAMESPACE }}
          echo ""
          if [ -n "${{ steps.urls.outputs.ingress_ip }}" ]; then
            echo "âœ… Application is ready!"
            echo "ğŸŒ Frontend URL: http://${{ steps.urls.outputs.ingress_ip }}"
            echo "ğŸŒ Backend API: http://${{ steps.urls.outputs.ingress_ip }}/api"
            echo "ğŸ¥ Health Check: http://${{ steps.urls.outputs.ingress_ip }}/api/health/live"
          else
            echo "â³ Load Balancer still provisioning (takes 5-15 minutes)"
            echo ""
            echo "ğŸ“‹ To check status:"
            echo "   kubectl get ingress dx03-ingress -n ${{ env.NAMESPACE }}"
            echo ""
            echo "ğŸ“‹ Once IP is assigned, access:"
            echo "   Frontend: http://<INGRESS_IP>"
            echo "   Backend:  http://<INGRESS_IP>/api"
            echo "   Health:   http://<INGRESS_IP>/api/health/live"
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "âœ… Application deployed successfully!"
          echo "ğŸ‰ All services are running"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "âŒ Application deployment failed!"
          echo "ğŸ”— Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
