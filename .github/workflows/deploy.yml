name: üöÄ Deploy Application to GKE

on:
  push:
    branches: [main, master]
    paths:
      - 'client/**'
      - 'server/**'
      - 'k8s/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: us-central1
  GKE_CLUSTER: tx03-gke-cluster
  ARTIFACT_REGISTRY: dx03
  NAMESPACE: dx03-dev

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dx03
        uses: actions/checkout@v4
        with:
          path: app

      - name: Checkout tx03 (for Terraform outputs)
        uses: actions/checkout@v4
        with:
          repository: maringelix/tx03
          path: tx03
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          echo "üîê Configuring Docker authentication..."
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Get GKE Credentials
        run: |
          echo "üîë Getting GKE credentials..."
          gcloud components install gke-gcloud-auth-plugin --quiet
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Build and Push Frontend
        working-directory: app/client
        run: |
          echo "üèóÔ∏è Building frontend image..."
          echo "üìÇ Current directory: $(pwd)"
          echo "üìÑ Files:"
          ls -la
          
          docker build \
            --build-arg VITE_API_URL=/api \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:latest \
            .
          
          echo "üì¶ Pushing frontend image..."
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:latest
          
          echo "‚úÖ Frontend image pushed successfully!"

      - name: Build and Push Backend
        working-directory: app/server
        run: |
          echo "üèóÔ∏è Building backend image..."
          
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:latest \
            .
          
          echo "üì¶ Pushing backend image..."
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:latest
          
          echo "‚úÖ Backend image pushed successfully!"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Get Database Credentials from Terraform
        id: db_creds
        working-directory: tx03/terraform/environments/dev
        run: |
          echo "üîç Getting database credentials from Terraform..."
          
          # Initialize Terraform to access outputs
          terraform init \
            -backend-config="bucket=${{ secrets.GCS_BUCKET }}" \
            -backend-config="prefix=terraform/state/dev"
          
          # Get database password
          DB_PASSWORD=$(terraform output -raw database_password)
          echo "::add-mask::$DB_PASSWORD"
          echo "db_password=$DB_PASSWORD" >> $GITHUB_OUTPUT
          
          # Get Cloud SQL private IP
          DB_HOST=$(terraform output -raw cloudsql_private_ip)
          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Database credentials retrieved"

      - name: Create Kubernetes Namespace
        continue-on-error: true
        run: |
          echo "üìÅ Creating namespace..."
          kubectl create namespace ${{ env.NAMESPACE }} || echo "Namespace already exists"
          kubectl label namespace ${{ env.NAMESPACE }} app=dx03 --overwrite

      - name: Create Database Secret
        run: |
          echo "üîê Creating database secret..."
          
          # Delete existing secret if exists
          kubectl delete secret dx03-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          
          # Create new secret (matching backend-deployment.yaml keys)
          kubectl create secret generic dx03-db-secret \
            --from-literal=host=${{ steps.db_creds.outputs.db_host }} \
            --from-literal=port=5432 \
            --from-literal=database=dx03 \
            --from-literal=username=dx03 \
            --from-literal=password=${{ steps.db_creds.outputs.db_password }} \
            --namespace=${{ env.NAMESPACE }}
          
          echo "‚úÖ Database secret created"

      - name: Apply ConfigMap
        working-directory: app
        run: |
          echo "‚öôÔ∏è Applying ConfigMap..."
          
          # Replace environment placeholder
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/configmap.yaml | kubectl apply -f -
          
          echo "‚úÖ ConfigMap applied"

      - name: Deploy Backend
        working-directory: app
        run: |
          echo "üöÄ Deploying backend..."
          
          # Delete old deployments to avoid config errors from old secrets
          kubectl delete deployment dx03-backend -n ${{ env.NAMESPACE }} --ignore-not-found=true
          sleep 10
          
          # Replace placeholders
          sed "s|IMAGE_PLACEHOLDER|${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }}|g; s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/backend-deployment.yaml | kubectl apply -f -
          
          # Apply service (replace placeholder)
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/backend-service.yaml | kubectl apply -f -
          
          echo "‚è≥ Waiting for backend rollout..."
          echo "üìä Checking pod status..."
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl describe deployment dx03-backend -n ${{ env.NAMESPACE }} | tail -20
          
          # Show pod details if still pending
          echo "üîç Checking pod events..."
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -20
          kubectl describe pods -n ${{ env.NAMESPACE }} -l app=dx03-backend | grep -A 10 "Events:"
          
          kubectl rollout status deployment/dx03-backend -n ${{ env.NAMESPACE }} --timeout=10m
          
          echo "‚úÖ Backend deployed successfully!"

      - name: Deploy Frontend
        working-directory: app
        run: |
          echo "üöÄ Deploying frontend..."
          
          # Replace placeholders
          sed "s|IMAGE_PLACEHOLDER|${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }}|g; s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/frontend-deployment.yaml | kubectl apply -f -
          
          # Apply service (replace placeholder)
          sed "s|ENVIRONMENT_PLACEHOLDER|dev|g" k8s/frontend-service.yaml | kubectl apply -f -
          
          echo "‚è≥ Waiting for frontend rollout..."
          kubectl rollout status deployment/dx03-frontend -n ${{ env.NAMESPACE }} --timeout=5m
          
          echo "‚úÖ Frontend deployed successfully!"

      - name: Apply Ingress
        run: |
          echo "üåê Applying Ingress..."
          
          # Create Ingress
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: dx03-ingress
            namespace: ${{ env.NAMESPACE }}
            annotations:
              kubernetes.io/ingress.class: "gce"
              networking.gke.io/managed-certificates: "dx03-cert"
          spec:
            rules:
            - http:
                paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: dx03-backend
                      port:
                        number: 3000
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: dx03-frontend
                      port:
                        number: 80
          EOF
          
          echo "‚úÖ Ingress applied!"

      - name: Get Application URLs
        id: urls
        run: |
          echo "üîç Getting application URLs..."
          
          # Wait for ingress to get IP
          echo "‚è≥ Waiting for Load Balancer IP..."
          for i in {1..30}; do
            INGRESS_IP=$(kubectl get ingress dx03-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$INGRESS_IP" ]; then
              echo "ingress_ip=$INGRESS_IP" >> $GITHUB_OUTPUT
              echo "üåê Ingress IP: $INGRESS_IP"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done
          
          if [ -z "$INGRESS_IP" ]; then
            echo "‚ö†Ô∏è  Ingress IP not yet assigned (will be available shortly)"
          fi

      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo ""
          echo "üéØ Environment: dev"
          echo "üì¶ Namespace: ${{ env.NAMESPACE }}"
          echo ""
          echo "üê≥ Images:"
          echo "  Frontend: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dx03/frontend:${{ github.sha }}"
          echo "  Backend:  us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/dx03/backend:${{ github.sha }}"
          echo ""
          echo "üîó Services:"
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo ""
          echo "üöÄ Deployments:"
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "üì¶ Pods:"
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          if [ -n "${{ steps.urls.outputs.ingress_ip }}" ]; then
            echo "üåê Application URL: http://${{ steps.urls.outputs.ingress_ip }}"
          else
            echo "‚è≥ Load Balancer provisioning... Check in a few minutes:"
            echo "   kubectl get ingress dx03-ingress -n ${{ env.NAMESPACE }}"
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "‚úÖ Application deployed successfully!"
          echo "üéâ All services are running"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "‚ùå Application deployment failed!"
          echo "üîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
